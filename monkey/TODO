move common routines into main

